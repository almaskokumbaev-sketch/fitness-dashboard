import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from openai import OpenAI
from datetime import datetime

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="Fitness Intelligence", layout="wide", page_icon="ü¶Å")
st.title("ü¶Å AI-–î–∏—Ä–µ–∫—Ç–æ—Ä: –ì–ª—É–±–æ–∫–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞")

# --- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ---
with st.sidebar:
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞")
    # –§–∏–ª—å—Ç—Ä –¥–∞—Ç –¥–ª—è —á–µ—Å—Ç–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    valid_date_limit = st.date_input("–°—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É '–ü—Ä–∏—à–µ–ª/–ù–µ—Ç' —Ç–æ–ª—å–∫–æ –¥–æ:", 
                                     value=pd.to_datetime("2025-12-21"))
    st.info(f"üìÖ –ó–∞–ø–∏—Å–∏ —Å –¥–∞—Ç–æ–π –≤–∏–∑–∏—Ç–∞ –ü–û–°–õ–ï {valid_date_limit} –Ω–µ –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è '–ø—Ä–æ–≥—É–ª—å—â–∏–∫–∞–º–∏', —Ç–∞–∫ –∫–∞–∫ –≤—Ä–µ–º—è –µ—â–µ –Ω–µ –ø—Ä–∏—à–ª–æ.")

# --- –ó–ê–ì–†–£–ó–ö–ê ---
SHEET_NAME = '–º–æ–π –ø–µ—Ä–≤—ã–π –¥—ç—à–±–æ—Ä–¥'

@st.cache_data(ttl=60)
def load_data():
    try:
        scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
        if "gcp_service_account" in st.secrets:
            creds_dict = dict(st.secrets["gcp_service_account"])
            creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        else:
            creds = ServiceAccountCredentials.from_json_keyfile_name('credentials.json', scope)
        
        client = gspread.authorize(creds)
        sheet = client.open(SHEET_NAME).sheet1
        return pd.DataFrame(sheet.get_all_records())
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞: {e}")
        return None

df = load_data()

# --- –§–£–ù–ö–¶–ò–Ø "–ú–û–ó–ì–ò" ---
def ask_ai_brain(stats_text, context_text):
    if "OPENAI_API_KEY" not in st.secrets:
        return "‚ö†Ô∏è –ù–µ—Ç –∫–ª—é—á–∞ API"
    
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    
    prompt = f"""
    –¢—ã ‚Äî –¢–æ–ø–æ–≤—ã–π –ê–Ω–∞–ª–∏—Ç–∏–∫ –î–∞–Ω–Ω—ã—Ö (Data Scientist) –≤ —Ñ–∏—Ç–Ω–µ—Å-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏.
    –¢–≤–æ—è —Ü–µ–ª—å: –ù–∞–π—Ç–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã (Outliers & Patterns), –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–µ—Å—É—Ç –¥–µ–Ω—å–≥–∏.
    
    –ö–û–ù–¢–ï–ö–°–¢ –û–¢ –í–õ–ê–î–ï–õ–¨–¶–ê:
    "{context_text}"
    "–í–∞–∂–Ω–æ: –ú—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–∂–∏, –Ω–æ –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ñ–∏–∫–∞. –î–∞–Ω–Ω—ã–µ '–î–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏' –≤–∞–ª–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –¥–æ 21 –¥–µ–∫–∞–±—Ä—è."

    –í–û–¢ –†–ê–°–°–ß–ò–¢–ê–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê):
    {stats_text}
    
    –ó–ê–î–ê–ß–ê - –î–ê–ô 5 –ú–û–©–ù–´–• –ò–ù–°–ê–ô–¢–û–í (–ï–ë–ï–ô–®–ò–•):
    1. ‚è≥ **–¶–∏–∫–ª —Å–¥–µ–ª–∫–∏:** –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ª—é–¥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç? –ü—Ä–∞–≤–¥–∞ –ª–∏, —á—Ç–æ "–î–µ–Ω—å –≤ –¥–µ–Ω—å" –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤—ã—à–µ? (–°–º–æ—Ç—Ä–∏ –±–ª–æ–∫ 'Lead Time').
    2. üîÑ **–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∏:** –°—Ç–æ–∏—Ç –ª–∏ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å? –ö–∞–∫–æ–≤–∞ –∏—Ö —Ä–µ–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –Ω–æ–≤—ã–º–∏?
    3. üïµÔ∏è **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –•–∞–Ω—Ç–µ—Ä–æ–≤:** –ö—Ç–æ –≥–æ–Ω–∏—Ç "–ø—É—Å—Ç–æ–π —Ç—Ä–∞—Ñ–∏–∫" (–º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π, –º–∞–ª–æ –¥–æ—Ö–æ–¥–æ–≤), –∞ —É –∫–æ–≥–æ "–∑–æ–ª–æ—Ç—ã–µ –ª–∏–¥—ã"?
    4. üìÖ **–ê–Ω–æ–º–∞–ª–∏–∏ –¥–Ω–µ–π:** –ë—ã–ª–∏ –ª–∏ –¥–Ω–∏ —Å –∫—É—á–µ–π –∑–∞–ø–∏—Å–µ–π, –Ω–æ –ø—Ä–æ–≤–∞–ª—å–Ω–æ–π –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å—é?
    5. üöÄ **–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:** –û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –≤—ã—Ä—É—á–∫—É –Ω–∞ 15%.
    
    –ü–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —Å —Ü–∏—Ñ—Ä–∞–º–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞. –ù–µ –ª–µ–π –≤–æ–¥—É.
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o", 
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ AI: {e}"

# --- –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° ---
if st.button('üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ'):
    st.cache_data.clear()

if df is not None:
    # ==========================================
    # üõ† –≠–¢–ê–ü 1: –ü–†–ï–ü–†–û–¶–ï–°–°–ò–ù–ì (–û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–•)
    # ==========================================
    
    # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ (–ø—Ä–æ–≤–µ—Ä—å —Ç–æ—á–Ω–æ—Å—Ç—å!)
    col_record_date = "–î–ê–¢–ê –ö–û–ì–î–ê –ó–ê–ü–ò–°–ê–õ–ò"
    col_visit_date = "–î–ê–¢–ê –ö–û–ì–î–ê –ü–†–ò–î–ï–¢" # –ò–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è –≤ —Ç–∞–±–ª–∏—Ü–µ
    col_manager = "–ú–µ–Ω–µ–¥–∂–µ—Ä"
    col_status = "–ü–†–ò–®–Å–õ/–ù–ï –ü–†–ò–®–Å–õ" # –ì–¥–µ —É–∫–∞–∑–∞–Ω–æ, –ø—Ä–∏—à–µ–ª –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –Ω–µ—Ç
    col_method = "–ú–µ—Ç–æ–¥ –∑–∞–ø–∏—Å–∏"     # –ì–¥–µ –∏—â–µ–º "–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å"
    
    # 2. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (Python datetime)
    # –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ
    df = df[df[col_record_date] != '']
    df = df[df[col_visit_date] != '']
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
    df['Record_DT'] = pd.to_datetime(df[col_record_date], dayfirst=True, errors='coerce')
    df['Visit_DT'] = pd.to_datetime(df[col_visit_date], dayfirst=True, errors='coerce')
    
    # 3. –°—á–∏—Ç–∞–µ–º "Lag" (–ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –∑–∞–ø–∏—Å–∞–ª—Å—è)
    df['Days_Before'] = (df['Visit_DT'] - df['Record_DT']).dt.days
    
    # 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—Ö–∞ (–ü—Ä–∏—à–µ–ª/–ö—É–ø–∏–ª)
    # –°—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º, –µ—Å–ª–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ –µ—Å—Ç—å "–ø—Ä–∏—à–µ–ª", "–∫—É–ø–∏–ª", "–¥–∞"
    df['Is_Success'] = df[col_status].astype(str).str.lower().str.contains('–ø—Ä–∏—à–µ–ª|–¥–∞|–∫—É–ø–∏–ª|–∞–±–æ–Ω–µ–º–µ–Ω—Ç', na=False)
    
    # 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º "–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å"
    df['Is_Reschedule'] = df[col_method].astype(str).str.lower().str.contains('–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å', na=False)

    # 6. –§–ò–õ–¨–¢–† –í–ê–õ–ò–î–ù–û–°–¢–ò (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
    # –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–ø–∏—Å–∏, –¥–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞ –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –ø—Ä–æ—à–ª–∞ (<= 21 –¥–µ–∫–∞–±—Ä—è –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã)
    df_valid = df[df['Visit_DT'] <= pd.to_datetime(valid_date_limit)]
    
    # ==========================================
    # üßÆ –≠–¢–ê–ü 2: –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê (–ê–ì–†–ï–ì–ê–¶–ò–Ø)
    # ==========================================
    
    st.write("üìä **–°—á–∏—Ç–∞—é —Å–ª–æ–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏...**")
    
    # --- –ê–ù–ê–õ–ò–ó 1: –¶–ò–ö–õ –°–î–ï–õ–ö–ò (LEAD TIME) ---
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º: 0 –¥–Ω–µ–π (–¥–µ–Ω—å –≤ –¥–µ–Ω—å), 1-2 –¥–Ω—è, 3-7 –¥–Ω–µ–π, 7+ –¥–Ω–µ–π
    def group_days(d):
        if d == 0: return "0. –î–µ–Ω—å –≤ –¥–µ–Ω—å"
        if 1 <= d <= 2: return "1. 1-2 –¥–Ω—è"
        if 3 <= d <= 7: return "2. –ù–µ–¥–µ–ª—è"
        return "3. –ó–∞—Ä–∞–Ω–µ–µ (>7 –¥–Ω–µ–π)"

    df_valid['Time_Group'] = df_valid['Days_Before'].apply(group_days)
    
    lead_time_stat = df_valid.groupby('Time_Group').agg(
        –í—Å–µ–≥–æ_–ó–∞–ø–∏—Å–µ–π=('Is_Success', 'count'),
        –†–µ–∞–ª—å–Ω–æ_–î–æ—à–ª–∏=('Is_Success', 'sum')
    )
    lead_time_stat['–î–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å %'] = (lead_time_stat['–†–µ–∞–ª—å–Ω–æ_–î–æ—à–ª–∏'] / lead_time_stat['–í—Å–µ–≥–æ_–ó–∞–ø–∏—Å–µ–π'] * 100).round(1)
    
    # --- –ê–ù–ê–õ–ò–ó 2: –ü–ï–†–ï–ó–ê–ü–ò–°–¨ VS –ù–û–í–´–ï ---
    reschedule_stat = df_valid.groupby('Is_Reschedule').agg(
        –í—Å–µ–≥–æ=('Is_Success', 'count'),
        –î–æ—à–ª–∏=('Is_Success', 'sum')
    )
    reschedule_stat['–ö–æ–Ω–≤–µ—Ä—Å–∏—è %'] = (reschedule_stat['–î–æ—à–ª–∏'] / reschedule_stat['–í—Å–µ–≥–æ'] * 100).round(1)
    reschedule_stat.index = ['–û–±—ã—á–Ω–∞—è –∑–∞–ø–∏—Å—å', '–ü–ï–†–ï–ó–ê–ü–ò–°–¨']
    
    # --- –ê–ù–ê–õ–ò–ó 3: –¢–û–ü –•–ê–ù–¢–ï–†–û–í (–ü–æ –∫–∞—á–µ—Å—Ç–≤—É) ---
    manager_stat = df_valid.groupby(col_manager).agg(
        –ó–∞–ø–∏—Å–∞–ª_–õ—é–¥–µ–π=('Is_Success', 'count'),
        –î–æ—à–ª–∏_–ù–æ–≥–∞–º–∏=('Is_Success', 'sum')
    )
    manager_stat['–ö–∞—á–µ—Å—Ç–≤–æ %'] = (manager_stat['–î–æ—à–ª–∏_–ù–æ–≥–∞–º–∏'] / manager_stat['–ó–∞–ø–∏—Å–∞–ª_–õ—é–¥–µ–π'] * 100).round(1)
    # –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö, —É –∫–æ–≥–æ –º–µ–Ω—å—à–µ 5 –∑–∞–ø–∏—Å–µ–π (—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
    manager_stat = manager_stat[manager_stat['–ó–∞–ø–∏—Å–∞–ª_–õ—é–¥–µ–π'] > 5].sort_values('–ö–∞—á–µ—Å—Ç–≤–æ %', ascending=False)

    # ==========================================
    # üß† –≠–¢–ê–ü 3: –û–¢–ü–†–ê–í–ö–ê –í –ò–ò
    # ==========================================
    
    col_l, col_r = st.columns([1, 2])
    
    with col_l:
        st.subheader("üïµÔ∏è –ì–ª—É–±–æ–∫–∏–π –ê–Ω–∞–ª–∏–∑")
        user_input = st.text_area("–î–æ–ø. –≤–æ–ø—Ä–æ—Å —Ä–æ–±–æ—Ç—É:", value="–í—ã—Ç–∞—â–∏ –∏–Ω—Å–∞–π—Ç—ã –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É —Ü–∏–∫–ª—É –¥–Ω–µ–π –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—è–º.")
        
        if st.button("üöÄ –ü–û–ò–°–ö –ò–ù–°–ê–ô–¢–û–í (10 –∏–∑ 10)"):
            with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤..."):
                # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∞
                full_report = f"""
                1. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –í–†–ï–ú–ï–ù–ò –ó–ê–ü–ò–°–ò (–ö–æ–≥–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è vs –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç):
                {lead_time_stat.to_string()}
                
                2. –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ –ü–ï–†–ï–ó–ê–ü–ò–°–ò (–†–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –Ω–µ—Ç?):
                {reschedule_stat.to_string()}
                
                3. –†–ï–ô–¢–ò–ù–ì –ú–ï–ù–ï–î–ñ–ï–†–û–í (–ü–æ –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
                {manager_stat.to_string()}
                """
                
                insight = ask_ai_brain(full_report, user_input)
                st.markdown(insight)
                
    with col_r:
        st.subheader("üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è")
        
        tab1, tab2, tab3 = st.tabs(["‚è≥ –¶–∏–∫–ª —Å–¥–µ–ª–∫–∏", "üîÑ –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∏", "üèÜ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã"])
        
        with tab1:
            st.write("–ö–∞–∫–∞—è –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å?")
            st.dataframe(lead_time_stat.style.background_gradient(cmap="Greens", subset=['–î–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å %']))
            st.bar_chart(lead_time_stat['–î–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å %'])
            
        with tab2:
            st.write("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏: –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å vs –û–±—ã—á–Ω–∞—è")
            st.dataframe(reschedule_stat)
            
        with tab3:
            st.write("–ö—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç —Å–∞–º—ã—Ö –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤?")
            st.dataframe(manager_stat.style.background_gradient(cmap="RdYlGn", subset=['–ö–∞—á–µ—Å—Ç–≤–æ %']))

else:
    st.warning("–ó–∞–≥—Ä—É–∑–∫–∞...")