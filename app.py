import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from openai import OpenAI

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
st.set_page_config(page_title="Smart Business AI", layout="wide")
st.title("üß† –£–º–Ω—ã–π –ê–Ω–∞–ª–∏–∑ –ë–∏–∑–Ω–µ—Å-–ü—Ä–æ—Ü–µ—Å—Å–æ–≤")

# --- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ---
with st.sidebar:
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ú–æ–∑–≥–∞")
    openai_api_key = st.text_input("–ö–ª—é—á OpenAI (sk-...)", type="password")
    
    st.divider()
    st.subheader("üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò")
    st.info("–û–±—ä—è—Å–Ω–∏ —Ä–æ–±–æ—Ç—É, —á—Ç–æ —ç—Ç–æ –∑–∞ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≥–∞–¥–∞–ª.")
    user_context = st.text_area(
        "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã:", 
        value="–≠—Ç–æ CRM —Ñ–∏—Ç–Ω–µ—Å-—Å–µ—Ç–∏. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - —ç—Ç–æ –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ. \n–í–∞–∂–Ω–æ: –î–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –¥–Ω—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ (–º–µ–Ω–µ–¥–∂–µ—Ä—ã –µ—â–µ –Ω–µ –≤–Ω–µ—Å–ª–∏ –∏—Ç–æ–≥–∏). \n–¶–µ–ª—å: –ü–æ–Ω—è—Ç—å, –∫—Ç–æ –∏–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç, –∏ –∫–∞–∫–∞—è —Ä–µ–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–∏–º–æ—Å—Ç—å (–ü–†–ò–®–ï–õ/–ù–ï –ü–†–ò–®–ï–õ).",
        height=150
    )

# --- –ó–ê–ì–†–£–ó–ö–ê ---
SHEET_NAME = '–º–æ–π –ø–µ—Ä–≤—ã–π –¥—ç—à–±–æ—Ä–¥'

@st.cache_data(ttl=60)
def load_data():
    try:
        scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
        creds = ServiceAccountCredentials.from_json_keyfile_name('credentials.json', scope)
        client = gspread.authorize(creds)
        sheet = client.open(SHEET_NAME).sheet1
        return pd.DataFrame(sheet.get_all_records())
    except Exception as e:
        return None

df = load_data()

# --- –§–£–ù–ö–¶–ò–Ø "–£–ú–ù–û–ì–û –í–ó–ì–õ–Ø–î–ê" ---
def analyze_with_context(df_sample, columns_info, specific_stats):
    if not openai_api_key:
        return "‚ö†Ô∏è –ù—É–∂–µ–Ω API –∫–ª—é—á!"
    
    client = OpenAI(api_key=openai_api_key)
    
    prompt = f"""
    –¢—ã ‚Äî –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ë–∏–∑–Ω–µ—Å-–ê–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–Ω—è—Ç—å —Å—É—Ç—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ "—Å—ã—Ä—ã–º" –¥–∞–Ω–Ω—ã–º –∏ –¥–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã.
    
    –ö–û–ù–¢–ï–ö–°–¢ –û–¢ –í–õ–ê–î–ï–õ–¨–¶–ê:
    "{user_context}"
    
    –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• (–ö–æ–ª–æ–Ω–∫–∏):
    {columns_info}
    
    –ü–†–ò–ú–ï–† –î–ê–ù–ù–´–• (–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):
    {df_sample}
    
    –í–ê–ñ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è):
    {specific_stats}
    
    –ó–ê–î–ê–ß–ê:
    1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ—Ä–æ–Ω–∫—É: –ö–∞–∫ –ª—é–¥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è? (–ö–æ–ª–æ–Ω–∫–∞ '–ú–µ—Ç–æ–¥ –∑–∞–ø–∏—Å–∏' –∏ –¥—Ä).
    2. –û—Ü–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: –ö—Ç–æ —Å–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–∞—Å–∞–Ω–∏–π?
    3. –ù–∞–π–¥–∏ –ø—Ä–æ–±–ª–µ–º—ã: –ï—Å—Ç—å –ª–∏ —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –≤ —Å—Ç–∞—Ç—É—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–Ω–æ–≥–æ "–ù–µ –ø—Ä–∏—à–µ–ª")?
    4. –î–∞–π 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã –æ—Ç–¥–µ–ª–∞ –ø—Ä–æ–¥–∞–∂, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.
    
    –û—Ç–≤–µ—Ç –¥–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –≥–ª–∞–≤–Ω–æ–≥–æ.
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o", 
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {e}"

# --- –ò–ù–¢–ï–†–§–ï–ô–° ---
if st.button('üîÑ –û–±–Ω–æ–≤–∏—Ç—å'):
    st.cache_data.clear()

if df is not None:
    # 1. –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    st.metric("–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π", len(df))
    st.divider()
    
    col_left, col_right = st.columns([1, 2])
    
    with col_left:
        st.subheader("ü§ñ AI-–ê–Ω–∞–ª–∏—Ç–∏–∫")
        if st.button("üß† –í–ö–õ–Æ–ß–ò–¢–¨ –ú–û–ó–ì (–ê–Ω–∞–ª–∏–∑ –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã)"):
            if not openai_api_key:
                st.error("–í—Å—Ç–∞–≤—å –∫–ª—é—á!")
            else:
                with st.spinner("–ò–∑—É—á–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç..."):
                    # --- –ì–û–¢–û–í–ò–ú –î–ê–ù–ù–´–ï –î–õ–Ø –ò–ò (–£–ú–ù–ê–Ø –í–´–ñ–ò–ú–ö–ê) ---
                    
                    # 1. –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ, —á—Ç–æ–±—ã –æ–Ω –ø–æ–Ω—è–ª —Ñ–æ—Ä–º–∞—Ç)
                    sample_data = df.head(5).to_string()
                    
                    # 2. –°–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫
                    cols = ", ".join(df.columns.tolist())
                    
                    # 3. –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–≤—ã–º –∫–æ–ª–æ–Ω–∫–∞–º (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
                    stats_summary = ""
                    # –ò—â–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–≥–¥–µ –º–∞–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π - —ç—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
                    for col in df.columns:
                        if df[col].dtype == 'object': # –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç
                            unique_count = df[col].nunique()
                            # –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –º–µ–Ω—å—à–µ 20 (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–º–µ–Ω–∞, –°—Ç–∞—Ç—É—Å—ã, –§–∏–ª–∏–∞–ª—ã)
                            if 1 < unique_count < 50: 
                                top_vals = df[col].value_counts().head(5).to_dict()
                                stats_summary += f"- –ö–æ–ª–æ–Ω–∫–∞ '{col}': –¢–æ–ø –∑–Ω–∞—á–µ–Ω–∏—è {top_vals}\n"
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GPT
                    insight = analyze_with_context(sample_data, cols, stats_summary)
                    st.markdown(insight)

    with col_right:
        st.subheader("üîé –î–∞–Ω–Ω—ã–µ (–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)")
        st.dataframe(df.head(50)) # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50 —Å—Ç—Ä–æ–∫
        
        # –ê–≤—Ç–æ-–≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        st.markdown("---")
        st.write("**–ë—ã—Å—Ç—Ä—ã–µ —Å—Ä–µ–∑—ã:**")
        
        # –ò—â–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
        possible_cols = [c for c in df.columns if df[c].nunique() < 15 and df[c].nunique() > 1]
        if possible_cols:
            selected_col = st.selectbox("–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–æ:", possible_cols, index=0)
            st.bar_chart(df[selected_col].value_counts())

else:
    st.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö")